name: Dependency Updates

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: ðŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ” Check for updates
      run: |
        npm outdated --json > outdated.json || true
        if [ -s outdated.json ]; then
          echo "ðŸ“¦ Found dependency updates:"
          cat outdated.json | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.wanted)"'
          echo "HAS_UPDATES=true" >> $GITHUB_ENV
        else
          echo "âœ… All dependencies are up to date"
          echo "HAS_UPDATES=false" >> $GITHUB_ENV
        fi
        
    - name: ðŸ“‹ Update dependencies
      if: env.HAS_UPDATES == 'true'
      run: |
        # æ›´æ–°éžä¸»ç‰ˆæœ¬ä¾èµ–
        npm update
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet package-lock.json; then
          echo "NO_CHANGES=true" >> $GITHUB_ENV
        else
          echo "NO_CHANGES=false" >> $GITHUB_ENV
        fi
        
    - name: ðŸ§ª Run tests
      if: env.HAS_UPDATES == 'true' && env.NO_CHANGES == 'false'
      run: |
        npm ci
        npm run type-check
        npm run test || echo "TEST_FAILED=true" >> $GITHUB_ENV
        
    - name: ðŸ“ Create Pull Request
      if: env.HAS_UPDATES == 'true' && env.NO_CHANGES == 'false' && env.TEST_FAILED != 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'ðŸ”„ chore: update dependencies'
        title: 'ðŸ”„ Automated dependency updates'
        body: |
          ## ðŸ”„ Automated Dependency Updates
          
          This PR updates dependencies to their latest compatible versions.
          
          ### ðŸ“¦ Updated packages:
          ```json
          $(cat outdated.json | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.wanted)"')
          ```
          
          ### âœ… Checks:
          - [x] Dependencies updated
          - [x] Tests passing
          - [x] Type checking passed
          
          This PR was automatically created by the dependency update workflow.
        branch: automated-dependency-updates
        delete-branch: true
        
    - name: ðŸ“Š Summary
      run: |
        if [ "${{ env.HAS_UPDATES }}" = "true" ]; then
          if [ "${{ env.NO_CHANGES }}" = "false" ]; then
            if [ "${{ env.TEST_FAILED }}" != "true" ]; then
              echo "## âœ… Dependency Update Successful" >> $GITHUB_STEP_SUMMARY
              echo "A pull request has been created with dependency updates." >> $GITHUB_STEP_SUMMARY
            else
              echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "Dependency updates are available but tests failed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Dependencies are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## âœ… All Up to Date" >> $GITHUB_STEP_SUMMARY
          echo "No dependency updates available." >> $GITHUB_STEP_SUMMARY
        fi
